# mmap学习

- [ ] [什么是mmap](https://zhuanlan.zhihu.com/p/357820303)
- [ ] [认真分析mmap](https://www.cnblogs.com/huxiao-tee/p/4660352.html)

**传统IO概念**

在开始谈论其他之前，先总结一下传统IO是什么样儿的。传统IO底层实际上通过调用`read()` 和 `write()`来实现。

通过`read`把数据从硬盘读写到内核缓冲区，再复制到用户缓冲区；然后再通过`write()`写入到`sokect缓冲区`,最后写入网卡设备。

![](https://pic4.zhimg.com/80/v2-9aba20b7e08d93a5c3044b40b830e5eb_720w.jpg)

整个过程发生了**4次用户态和内核态的上下文切换**和**4次拷贝**，流程如下：
1. 用户进程通过read()方法向操作系统发起调用，此时上下文从用户态转向内核态
2. DMA控制器把数据从硬盘中拷贝到读缓冲区
3. CPU把读缓冲区数据拷贝到应用缓冲区，上下文从内核态转为用户态，read()返回
4. 用户进程通过write()方法发起调用，上下文从用户态转为内核态
5. CPU将应用缓冲区中数据拷贝到socket缓冲区
6. DMA控制器把数据从socket缓冲区拷贝到网卡，上下文从内核态切换回用户态，write()返回

**用户态、内核态是什么**
用户空间指的就是用户进程运行的空间，内核空间指的是内核的运行空间。两者是隔离的，而且在他们之间上下文切换也是比较耗时的。

**DMA拷贝是什么**

因为对于一个IO操作而言，都是CPU发出指令来完成，但是和CPU相比，IO的速度太慢了，CPU有大量的时间出于等待IO的状态。因此就产生了DMA(Direct Memory Access)的直接内存访问技术，本质上来说他是一块主板上的独立芯片，通过它来进行内存和IO设备的数据传输，从而减少CPU的等待时间。

**零拷贝概念**

零拷贝技术是指计算机执行操作时，CPU不需要先将数据从某处内存复制到另一个特定区域，这种技术通常用于通过网络传输文件时节省CPU周期和内存带宽。

所以对于零拷贝这个概念而言，并非是真正完全没有数据拷贝的过程，只不过是减少用户态和内核态的切换次数以及CPU拷贝的次数。

**mmap是什么**

`mmap`主要实现方式是将内核缓冲区的地址和用户缓冲区的地址进行映射，内核缓冲区和应用缓冲区共享，从而减少了一次从内核缓冲区到用户缓冲区的CPU拷贝。

**mmap+write**

介绍完了相关的基础概念，来看一下用mmap代替read操作是什么样儿的。

![](https://pic3.zhimg.com/80/v2-4ce7da073ca07a4c3ab1c23293edfbba_720w.jpg)

整个过程发生了**4次内核态和用户态的上下文切换**和**3次拷贝**，流程如下：
1. 用户进程通过`mmap()`方法向操作系统发起调用，上下文从用户态转向内核态；
2. DMA控制器把数据从硬盘拷贝到内核缓冲区；
3. 上下文从内核态转向用户态，mmap调用返回；
4. 用户通过`write()`发起调用，上下文从用户态转为内核态；
5. DMA控制器把数据从socket缓冲区拷贝到网卡，上下文从内核态切换回用户态，`write()`返回；